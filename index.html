<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Herramienta de Respiración Fluida</title>
<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background-color: #f0f7ff;
    margin: 0;
    padding: 1rem 0;
    flex-direction: column;
}
.breathing-tool {
    text-align: center;
    background-color: white;
    padding: 1.5rem;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    width: 90%;
    max-width: 500px;
}
.circle-container {
    position: relative;
    width: 180px;
    height: 180px;
    margin: 1.5rem auto;
    display: flex;
    align-items: center;
    justify-content: center;
}
.circle {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    position: absolute;
    z-index: 1;
    transition: transform 0.05s linear;
}
.instructions { font-size: 1.5rem; color: #333; position: relative; z-index: 2; }
.timer, .reps-counter { font-size: 1.2rem; color: #555; margin-top: 1rem; }
.controls button { background-color: #4a90e2; color: white; border: none; padding: 0.8rem 1.5rem; margin: 0.5rem; border-radius: 8px; cursor: pointer; font-size: 1rem; }
.mode-selection { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
.mode-selection button { background-color: #f5f5f5; color:#333; border:1px solid #ddd; padding:0.6rem 0.8rem; border-radius:8px; cursor:pointer; }
.mode-selection button.active { background-color: #a2d2ff; border-color: #a2d2ff; font-weight:bold; }
.reps-control { margin-top: 1rem; font-size: 1rem; }
.reps-control label { margin-right: 10px; }
.reps-control input { width:60px; padding:8px; font-size:1rem; text-align:center; border:1px solid #ccc; border-radius:5px; }
.explanation { margin-top:1.5rem; padding:0 1rem; color:#666; min-height:60px; font-style:italic; }
@media(max-width:768px){ h1{font-size:1.8rem;} .instructions{font-size:1.8rem;} .timer,.reps-counter{font-size:1.4rem;} .circle-container{width:220px;height:220px;} .mode-selection button{font-size:1rem;padding:0.8rem 1rem;} .controls button{font-size:1.2rem;padding:1rem 1.8rem;} .reps-control{font-size:1.2rem;} }
</style>
</head>
<body>

<div class="breathing-tool">
<h1>Respira y Relájate</h1>
<div class="circle-container">
    <div class="circle" style="background-color: rgb(74,144,226)"></div>
    <div class="instructions" id="instructions">Selecciona un modo</div>
</div>
<div class="timer" id="timer">Tiempo: 0s</div>
<div class="reps-counter" id="reps-counter">Repeticiones: 0</div>

<div class="mode-selection">
    <button id="mode-478">Respiración 4-7-8</button>
    <button id="mode-4444">Respiración de Caja</button>
    <button id="mode-diaphragmatic">Respiración Diafragmática</button>
</div>

<div class="explanation" id="explanation-box"><p>Selecciona un modo para ver su descripción.</p></div>

<div class="reps-control">
<label for="reps-input">Nº de Repeticiones:</label>
<input type="number" id="reps-input" value="4" min="1" max="50">
</div>

<div class="controls">
<button id="start-stop-btn">Iniciar</button>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
const instructions = document.getElementById('instructions');
const timerDisplay = document.getElementById('timer');
const repsCounter = document.getElementById('reps-counter');
const circle = document.querySelector('.circle');
const startStopBtn = document.getElementById('start-stop-btn');
const repsInput = document.getElementById('reps-input');
const explanationBox = document.getElementById('explanation-box');

const mode478Btn = document.getElementById('mode-478');
const mode4444Btn = document.getElementById('mode-4444');
const modeDiaphragmaticBtn = document.getElementById('mode-diaphragmatic');

let currentMode = '';
let reps = 0;
let isRunning = false;
let cancelAnimation = false;

// Colores en rgb para interpolación suave
const colorMap = { 'Inhala':'rgb(74,144,226)', 'Mantén':'rgb(255,76,76)', 'Exhala':'rgb(76,175,80)' };

const modes = {
    '478': {name:'Respiración 4-7-8', cycles:[{instruction:'Inhala',duration:4},{instruction:'Mantén',duration:7},{instruction:'Exhala',duration:8}], explanation:'Muy útil para calmarse antes de dormir o frenar picos de ansiedad. Se enfoca más en relajación profunda que en uso prolongado.'},
    '4444': {name:'Respiración de Caja (4-4-4-4)', cycles:[{instruction:'Inhala',duration:4},{instruction:'Mantén',duration:4},{instruction:'Exhala',duration:4}], explanation:'Buena para situaciones de estrés puntual (presentaciones, crisis leve). Fácil de recordar y usar en cualquier lugar.'},
    'diaphragmatic': {name:'Respiración Diafragmática', cycles:[{instruction:'Inhala',duration:4},{instruction:'Exhala',duration:6}], explanation:'Es el patrón más estudiado para ansiedad crónica. Bajar la respiración a ~6/min regula el sistema nervioso a largo plazo.'}
};

function selectMode(selectedMode){
    currentMode = selectedMode;
    reps=0;
    repsCounter.textContent=`Repeticiones: ${reps}`;
    instructions.textContent = modes[currentMode].name;
    explanationBox.innerHTML = `<p>${modes[currentMode].explanation}</p>`;
    [mode478Btn, mode4444Btn, modeDiaphragmaticBtn].forEach(btn=>btn.classList.remove('active'));
    document.getElementById(`mode-${selectedMode}`).classList.add('active');
}

function rgbToArray(rgb){
    return rgb.match(/\d+/g).map(Number);
}

function interpolateColor(c1,c2,t){
    const [r1,g1,b1]=rgbToArray(c1);
    const [r2,g2,b2]=rgbToArray(c2);
    return `rgb(${Math.round(r1+(r2-r1)*t)},${Math.round(g1+(g2-g1)*t)},${Math.round(b1+(b2-b1)*t)})`;
}

function startBreathing(){
    if(!currentMode){alert('Por favor, selecciona un modo de respiración.'); return;}
    const targetReps=parseInt(repsInput.value,10);
    if(isNaN(targetReps)||targetReps<=0){alert('Introduce un número válido de repeticiones.'); return;}
    reps=0;
    repsCounter.textContent=`Repeticiones: ${reps}`;
    cancelAnimation=false;
    let cycleIndex=0;

    function runCycle(){
        if(cancelAnimation) return;
        const currentCycle = modes[currentMode].cycles[cycleIndex];
        instructions.textContent = currentCycle.instruction;
        const colorStart = circle.style.backgroundColor || colorMap[currentCycle.instruction];
        const colorEnd = colorMap[currentCycle.instruction];

        let scaleStart, scaleEnd;
        if(currentCycle.instruction==='Inhala'){scaleStart=1; scaleEnd=1.2;}
        else if(currentCycle.instruction==='Mantén'){scaleStart=1.2; scaleEnd=1.2;}
        else if(currentCycle.instruction==='Exhala'){scaleStart=1.2; scaleEnd=0.8;}

        const duration=currentCycle.duration;
        const startTime=Date.now();

        function animate(){
            if(cancelAnimation) return;
            const elapsed=(Date.now()-startTime)/1000;
            const progress=Math.min(elapsed/duration,1);

            const currentScale = scaleStart + (scaleEnd - scaleStart) * progress;
            circle.style.transform=`scale(${currentScale})`;
            circle.style.backgroundColor = interpolateColor(colorStart,colorEnd,progress);

            timerDisplay.textContent=`Tiempo: ${Math.ceil(duration - elapsed)}s`;

            if(progress<1) requestAnimationFrame(animate);
            else{
                cycleIndex++;
                if(cycleIndex>=modes[currentMode].cycles.length){
                    cycleIndex=0;
                    reps++;
                    repsCounter.textContent=`Repeticiones: ${reps}`;
                    if(reps>=targetReps){completeSession(); return;}
                }
                runCycle();
            }
        }
        animate();
    }

    runCycle();
}

function completeSession(){
    cancelAnimation=true;
    circle.style.transform='scale(1)';
    instructions.textContent='¡Completado!';
    startStopBtn.textContent='Iniciar';
    isRunning=false;
}

function resetTool(){
    cancelAnimation=true;
    circle.style.transform='scale(1)';
    instructions.textContent='Selecciona un modo';
    timerDisplay.textContent='Tiempo: 0s';
    reps=0;
    repsCounter.textContent=`Repeticiones: ${reps}`;
    explanationBox.innerHTML='<p>Selecciona un modo para ver su descripción.</p>';
    circle.style.backgroundColor='';
    isRunning=false;
}

mode478Btn.addEventListener('click',()=>selectMode('478'));
mode4444Btn.addEventListener('click',()=>selectMode('4444'));
modeDiaphragmaticBtn.addEventListener('click',()=>selectMode('diaphragmatic'));
startStopBtn.addEventListener('click',()=>{
    if(isRunning){ resetTool(); }
    else{ startBreathing(); startStopBtn.textContent='Detener'; isRunning=true;}
});
});
</script>

</body>
</html>
