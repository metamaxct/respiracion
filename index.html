<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Herramienta de Respiración</title>
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <link rel="apple-touch-icon" href="icon-192.png">
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background-color: #f0f7ff;
      margin: 0;
      padding: 1rem 0;
      flex-direction: column;
      -webkit-text-size-adjust: 100%;
    }
    .breathing-tool {
      text-align: center;
      background-color: white;
      padding: 1.5rem;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 500px;
    }
    .circle-container {
      position: relative;
      width: 180px;
      height: 180px;
      margin: 1.5rem auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .circle {
      width: 100%;
      height: 100%;
      background-color: #a2d2ff;
      border-radius: 50%;
      position: absolute;
      z-index: 1;
      transition: transform 3s ease-in-out, background-color 1.5s ease;
    }
    .circle.breathing { animation: breathe 8s infinite ease-in-out; }
    @keyframes breathe { 0%,100% { transform: scale(0.8);} 50% { transform: scale(1);} }
    .instructions { font-size: 1.5rem; color: #333; position: relative; z-index: 2; }
    .timer, .reps-counter { font-size: 1.2rem; color: #555; margin-top: 1rem; }
    .controls button {
      background-color: #4a90e2; color: white; border: none;
      padding: 0.8rem 1.5rem; margin: 0.5rem; border-radius: 8px;
      cursor: pointer; font-size: 1rem; transition: background-color 0.3s;
    }
    .mode-selection { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
    .mode-selection button {
      background-color: #f5f5f5; color: #333; border: 1px solid #ddd;
      padding: 0.6rem 0.8rem; border-radius: 8px; font-size: 0.9rem; cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .mode-selection button.active {
      background-color: #a2d2ff; border-color: #a2d2ff; font-weight: bold;
    }
    .reps-control { margin-top: 1rem; font-size: 1rem; }
    .reps-control input {
      width: 60px; padding: 8px; font-size: 1rem; text-align: center;
      border: 1px solid #ccc; border-radius: 5px;
    }
    .explanation { margin-top: 1.5rem; padding: 0 1rem; color: #666; min-height: 60px; font-style: italic; }
  </style>
</head>
<body>
  <div class="breathing-tool">
    <h1>Respira y Relájate</h1>
    <div class="circle-container">
      <div class="circle" id="circle"></div>
      <div class="instructions" id="instructions">Selecciona un modo</div>
    </div>
    <div class="timer" id="timer">Tiempo: 0s</div>
    <div class="reps-counter" id="reps-counter">Repeticiones: 0</div>
    <div class="mode-selection">
      <button id="mode-478" type="button">Respiración 4-7-8</button>
      <button id="mode-4444" type="button">Respiración de Caja</button>
      <button id="mode-diaphragmatic" type="button">Respiración Diafragmática</button>
    </div>
    <div class="explanation" id="explanation-box">
      <p>Selecciona un modo para ver su descripción.</p>
    </div>
    <div class="reps-control">
      <label for="reps-input">Nº de Repeticiones:</label>
      <input type="number" id="reps-input" value="4" min="1" max="50">
    </div>
    <div class="controls">
      <button id="start-stop-btn" type="button">Iniciar</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const instructions = document.getElementById('instructions');
      const timerDisplay = document.getElementById('timer');
      const repsCounter = document.getElementById('reps-counter');
      const circle = document.getElementById('circle');
      const startStopBtn = document.getElementById('start-stop-btn');
      const repsInput = document.getElementById('reps-input');
      const explanationBox = document.getElementById('explanation-box');
      const mode478Btn = document.getElementById('mode-478');
      const mode4444Btn = document.getElementById('mode-4444');
      const modeDiaphragmaticBtn = document.getElementById('mode-diaphragmatic');
      let countdownTimer = null;
      let currentMode = '';
      let reps = 0;
      let isRunning = false;
      const colorMap = { 'Inhala': '#a2d2ff', 'Mantén': '#ff8a80', 'Exhala': '#b9f6ca', 'Pausa': '#ff8a80' };
      const modes = {
        '478': { name: 'Respiración 4-7-8', cycles: [{ instruction: 'Inhala', duration: 4 }, { instruction: 'Mantén', duration: 7 }, { instruction: 'Exhala', duration: 8 }], explanation: 'Muy útil para calmarse antes de dormir o frenar picos de ansiedad.' },
        '4444': { name: 'Respiración de Caja (4-4-4-4)', cycles: [{ instruction: 'Inhala', duration: 4 }, { instruction: 'Mantén', duration: 4 }, { instruction: 'Exhala', duration: 4 }, { instruction: 'Pausa', duration: 4 }], explanation: 'Buena para situaciones de estrés puntual.' },
        'diaphragmatic': { name: 'Respiración Diafragmática', cycles: [{ instruction: 'Inhala', duration: 4 }, { instruction: 'Exhala', duration: 6 }], explanation: 'Patrón más estudiado para ansiedad crónica.' }
      };
      function selectMode(selectedMode) {
        if (!modes[selectedMode]) return;
        currentMode = selectedMode;
        reps = 0;
        repsCounter.textContent = `Repeticiones: ${reps}`;
        instructions.textContent = modes[currentMode].name;
        explanationBox.innerHTML = `<p>${modes[currentMode].explanation}</p>`;
        [mode478Btn, mode4444Btn, modeDiaphragmaticBtn].forEach(btn => btn.classList.remove('active'));
        document.getElementById(`mode-${selectedMode}`).classList.add('active');
      }
      function startBreathing() {
        if (!currentMode) { alert('Por favor, selecciona un modo.'); return; }
        const targetReps = parseInt(repsInput.value, 10);
        if (isNaN(targetReps) || targetReps <= 0) { alert('Introduce repeticiones válidas.'); return; }
        let cycleIndex = 0;
        reps = 0;
        repsCounter.textContent = `Repeticiones: ${reps}`;
        function runCycle() {
          const currentCycle = modes[currentMode].cycles[cycleIndex];
          instructions.textContent = currentCycle.instruction;
          circle.style.backgroundColor = colorMap[currentCycle.instruction] || '#a2d2ff';
          let duration = currentCycle.duration;
          if (countdownTimer) clearInterval(countdownTimer);
          countdownTimer = setInterval(() => {
            timerDisplay.textContent = `Tiempo: ${duration}s`;
            duration--;
            if (duration < 0) {
              clearInterval(countdownTimer);
              cycleIndex++;
              if (cycleIndex >= modes[currentMode].cycles.length) {
                cycleIndex = 0;
                reps++;
                repsCounter.textContent = `Repeticiones: ${reps}`;
                if (reps >= targetReps) { completeSession(); return; }
              }
              setTimeout(runCycle, 120);
            }
          }, 1000);
        }
        runCycle();
        circle.classList.add('breathing');
      }
      function completeSession() {
        stopBreathing();
        instructions.textContent = '¡Completado!';
        startStopBtn.textContent = 'Iniciar';
        isRunning = false;
      }
      function stopBreathing() {
        if (countdownTimer) clearInterval(countdownTimer);
        countdownTimer = null;
        circle.classList.remove('breathing');
      }
      function resetTool() {
        stopBreathing();
        instructions.textContent = 'Selecciona un modo';
        timerDisplay.textContent = 'Tiempo: 0s';
        reps = 0;
        repsCounter.textContent = `Repeticiones: ${reps}`;
        explanationBox.innerHTML = '<p>Selecciona un modo para ver su descripción.</p>';
        circle.style.backgroundColor = '';
      }
      mode478Btn.addEventListener('click', () => selectMode('478'));
      mode4444Btn.addEventListener('click', () => selectMode('4444'));
      modeDiaphragmaticBtn.addEventListener('click', () => selectMode('diaphragmatic'));
      startStopBtn.addEventListener('click', () => {
        if (isRunning) { resetTool(); startStopBtn.textContent = 'Iniciar'; isRunning = false; }
        else { startBreathing(); startStopBtn.textContent = 'Detener'; isRunning = true; }
      });
      // Selecciona por defecto el modo 4-7-8
      selectMode('478');
    });
  </script>
</body>
</html>
